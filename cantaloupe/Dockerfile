# syntax=docker/dockerfile:1.4.3
ARG repository=local
ARG tag=latest
ARG alpine=3.16.2
FROM --platform=$BUILDPLATFORM ${repository}/download:${tag} AS download

ARG CANTALOUPE_VERSION="4.1.5"
ARG CANTALOUPE_SHA256="a117061727f1de1c0f514659ec537c080a7f540199643244d1c9cbb50d73027d"

RUN --mount=type=cache,id=cantaloupe-downloads,sharing=locked,target=/opt/downloads \
    CANTALOUPE_FILE="cantaloupe-${CANTALOUPE_VERSION}.zip" && \
    CANTALOUPE_URL="https://github.com/medusa-project/cantaloupe/releases/download/v${CANTALOUPE_VERSION}/${CANTALOUPE_FILE}" && \
    download.sh --url "${CANTALOUPE_URL}" --sha256 "${CANTALOUPE_SHA256}" "${DOWNLOAD_CACHE_DIRECTORY}" && \
    unzip "${DOWNLOAD_CACHE_DIRECTORY}/${CANTALOUPE_FILE}" -d /tmp && \
    CANTALOUPE_UNPACKED="${CANTALOUPE_FILE%.zip}" && \
    install-war-into-tomcat.sh --name "cantaloupe" --file "/tmp/${CANTALOUPE_UNPACKED}/${CANTALOUPE_UNPACKED}.war" && \
    rm -fr "/tmp/${CANTALOUPE_UNPACKED}"

FROM alpine:${alpine} AS cache
FROM ${repository}/tomcat:${tag}

# Opted for OpenJPG over Kakadu but that could be changed.
# For reference see: https://cantaloupe-project.github.io/manual/3.3/processors.html
RUN --mount=type=cache,id=cantaloupe-apk,sharing=locked,from=cache,target=/var/cache/apk \
    apk add \
        ffmpeg \
        imagemagick \
        openjpeg-tools \
    && \
    cleanup.sh

ENV \
    CANTALOUPE_ADMIN_ENABLED="true" \
    CANTALOUPE_ADMIN_PASSWORD="password" \
    CANTALOUPE_AMAZONS3CACHE_BUCKET_NAME= \
    CANTALOUPE_AMAZONS3CACHE_BUCKET_REGION= \
    CANTALOUPE_AMAZONS3CACHE_OBJECT_KEY_PREFIX= \
    CANTALOUPE_AUTH_BASIC_ENABLED="false" \
    CANTALOUPE_AUTH_BASIC_SECRET="password" \
    CANTALOUPE_AUTH_BASIC_USERNAME="admin" \
    CANTALOUPE_AZURESTORAGECACHE_ACCOUNT_KEY= \
    CANTALOUPE_AZURESTORAGECACHE_ACCOUNT_NAME= \
    CANTALOUPE_AZURESTORAGECACHE_CONTAINER_NAME= \
    CANTALOUPE_AZURESTORAGECACHE_OBJECT_KEY_PREFIX= \
    CANTALOUPE_AZURESTORAGESOURCE_ACCOUNT_KEY= \
    CANTALOUPE_AZURESTORAGESOURCE_ACCOUNT_NAME= \
    CANTALOUPE_AZURESTORAGESOURCE_CHUNKING_CACHE_ENABLED="true" \
    CANTALOUPE_AZURESTORAGESOURCE_CHUNKING_CACHE_MAX_SIZE="5M" \
    CANTALOUPE_AZURESTORAGESOURCE_CHUNKING_CHUNK_SIZE="512K" \
    CANTALOUPE_AZURESTORAGESOURCE_CHUNKING_ENABLED="true" \
    CANTALOUPE_AZURESTORAGESOURCE_CONTAINER_NAME= \
    CANTALOUPE_AZURESTORAGESOURCE_LOOKUP_STRATEGY="BasicLookupStrategy" \
    CANTALOUPE_BASE_URI= \
    CANTALOUPE_CACHE_CLIENT_ENABLED="true" \
    CANTALOUPE_CACHE_CLIENT_MAX_AGE="2592000" \
    CANTALOUPE_CACHE_CLIENT_MUST_REVALIDATE="false" \
    CANTALOUPE_CACHE_CLIENT_NO_CACHE="false" \
    CANTALOUPE_CACHE_CLIENT_NO_STORE="false" \
    CANTALOUPE_CACHE_CLIENT_NO_TRANSFORM="true" \
    CANTALOUPE_CACHE_CLIENT_PRIVATE="false" \
    CANTALOUPE_CACHE_CLIENT_PROXY_REVALIDATE="false" \
    CANTALOUPE_CACHE_CLIENT_PUBLIC="true" \
    CANTALOUPE_CACHE_CLIENT_SHARED_MAX_AGE= \
    CANTALOUPE_CACHE_SERVER_DERIVATIVE= \
    CANTALOUPE_CACHE_SERVER_DERIVATIVE_ENABLED="false" \
    CANTALOUPE_CACHE_SERVER_DERIVATIVE_TTL_SECONDS="2592000" \
    CANTALOUPE_CACHE_SERVER_INFO_ENABLED="true" \
    CANTALOUPE_CACHE_SERVER_PURGE_MISSING="false" \
    CANTALOUPE_CACHE_SERVER_RESOLVE_FIRST="false" \
    CANTALOUPE_CACHE_SERVER_SOURCE="FilesystemCache" \
    CANTALOUPE_CACHE_SERVER_SOURCE_TTL_SECONDS="2592000" \
    CANTALOUPE_CACHE_SERVER_WORKER_ENABLED="false" \
    CANTALOUPE_CACHE_SERVER_WORKER_INTERVAL="86400" \
    CANTALOUPE_DELEGATE_SCRIPT_CACHE_ENABLED="false" \
    CANTALOUPE_DELEGATE_SCRIPT_ENABLED="false" \
    CANTALOUPE_DELEGATE_SCRIPT_PATHNAME="delegates.rb" \
    CANTALOUPE_DYNAMODBCACHE_ACCESS_KEY_ID= \
    CANTALOUPE_DYNAMODBCACHE_ENDPOINT= \
    CANTALOUPE_DYNAMODBCACHE_SECTRE_KEY= \
    CANTALOUPE_DYNAMODBCACHE_TABLE_NAME="CantaloupeDynamoDBCache" \
    CANTALOUPE_ENDPOINT_ADMIN_ENABLED="false" \
    CANTALOUPE_ENDPOINT_ADMIN_SECRET= \
    CANTALOUPE_ENDPOINT_ADMIN_USERNAME="admin" \
    CANTALOUPE_ENDPOINT_API_ENABLED="false" \
    CANTALOUPE_ENDPOINT_API_SECRET= \
    CANTALOUPE_ENDPOINT_API_USERNAME= \
    CANTALOUPE_ENDPOINT_IIIF_1_ENABLED="true" \
    CANTALOUPE_ENDPOINT_IIIF_2_ENABLED="true" \
    CANTALOUPE_ENDPOINT_IIIF_CONTENT_DISPOSITION="inline" \
    CANTALOUPE_ENDPOINT_IIIF_MIN__SIZE="64" \
    CANTALOUPE_ENDPOINT_IIIF_MIN_TILE_SIZE="1024" \
    CANTALOUPE_ENDPOINT_IIIF_RESTRICT_TO_SIZES="false" \
    CANTALOUPE_FFMPEGPROCESSOR_PATH_TO_BINARIES= \
    CANTALOUPE_FILESYSTEMCACHE_DIR_DEPTH="3" \
    CANTALOUPE_FILESYSTEMCACHE_DIR_NAME_LENGTH="2" \
    CANTALOUPE_FILESYSTEMCACHE_PATHNAME="/data" \
    CANTALOUPE_FILESYSTEMSOURCE_BASICLOOKUPSTRATEGY_PATH_PREFIX="/var/www/drupal/web/" \
    CANTALOUPE_FILESYSTEMSOURCE_BASICLOOKUPSTRATEGY_PATH_SUFFIX= \
    CANTALOUPE_FILESYSTEMSOURCE_LOOKUP_STRATEGY="BasicLookupStrategy" \
    CANTALOUPE_HEAPCACHE_PERSIST="false" \
    CANTALOUPE_HEAPCACHE_PERSIST_FILESYSTEM_PATHNAME="/var/cache/cantaloupe/heap.cache" \
    CANTALOUPE_HEAPCACHE_TARGET_SIZE="2G" \
    CANTALOUPE_HTTP_ENABLED="true" \
    CANTALOUPE_HTTP_HOST="0.0.0.0" \
    CANTALOUPE_HTTP_PORT="8182" \
    CANTALOUPE_HTTPS_ENABLED="false" \
    CANTALOUPE_HTTPS_HOST="0.0.0.0" \
    CANTALOUPE_HTTPS_KEY_PASSWORD="password" \
    CANTALOUPE_HTTPS_KEY_STORE_PASSWORD="password" \
    CANTALOUPE_HTTPS_KEY_STORE_PATH="/path/to/keystore.jks" \
    CANTALOUPE_HTTPS_KEY_STORE_TYPE="JKS" \
    CANTALOUPE_HTTPS_PORT="8183" \
    CANTALOUPE_HTTPSOURCE_ALLOW_INSECURE="false" \
    CANTALOUPE_HTTPSOURCE_AUTH_BASIC_SECRET= \
    CANTALOUPE_HTTPSOURCE_AUTH_BASIC_USERNAME= \
    CANTALOUPE_HTTPSOURCE_BASICLOOKUPSTRATEGY_URL_PREFIX= \
    CANTALOUPE_HTTPSOURCE_BASICLOOKUPSTRATEGY_URL_SUFFIX= \
    CANTALOUPE_HTTPSOURCE_CHUNKING_CACHE_ENABLED="true" \
    CANTALOUPE_HTTPSOURCE_CHUNKING_CACHE_MAX_SIZE="5M" \
    CANTALOUPE_HTTPSOURCE_CHUNKING_CHUNK_SIZE="512K" \
    CANTALOUPE_HTTPSOURCE_CHUNKING_ENABLED="true" \
    CANTALOUPE_HTTPSOURCE_LOOKUP_STRATEGY="BasicLookupStrategy" \
    CANTALOUPE_HTTPSOURCE_REQUEST_TIMEOUT= \
    CANTALOUPE_JDBCCACHE_CONNECTION_TIMEOUT="10" \
    CANTALOUPE_JDBCCACHE_DERIVATIVE_IMAGE_TABLE="derivative_cache" \
    CANTALOUPE_JDBCCACHE_INFO_TABLE="info_cache" \
    CANTALOUPE_JDBCCACHE_PASSWORD="password" \
    CANTALOUPE_JDBCCACHE_URL="jdbc:postgresql://database:5432/cantaloupe" \
    CANTALOUPE_JDBCCACHE_USER="admin" \
    CANTALOUPE_JDBCSOURE_CONNECTION_TIMEOUT="10" \
    CANTALOUPE_JDBCSOURE_PASSWORD="password" \
    CANTALOUPE_JDBCSOURE_URL="jdbc:postgresql://database:5432/cantaloupe" \
    CANTALOUPE_JDBCSOURE_USER="admin" \
    CANTALOUPE_LOG_ACCESS_CONSOLEAPPENDER_ENABLED="true" \
    CANTALOUPE_LOG_ACCESS_FILEAPPENDER_ENABLED="false" \
    CANTALOUPE_LOG_ACCESS_FILEAPPENDER_PATHNAME="/opt/tomcat/logs/cantaloupe.access.log" \
    CANTALOUPE_LOG_ACCESS_ROLLINGFILEAPPENDER_ENABLED="false" \
    CANTALOUPE_LOG_ACCESS_ROLLINGFILEAPPENDER_PATHNAME="/opt/tomcat/logs/cantaloupe.access.log" \
    CANTALOUPE_LOG_ACCESS_ROLLINGFILEAPPENDER_POLICY="TimeBasedRollingPolicy" \
    CANTALOUPE_LOG_ACCESS_ROLLINGFILEAPPENDER_TIMEBASEDROLLINGPOLICY_FILENAME_PATTERN="/opt/tomcat/logs/cantaloupe.access-%d{yyyy-MM-dd}.log" \
    CANTALOUPE_LOG_ACCESS_ROLLINGFILEAPPENDER_TIMEBASEDROLLINGPOLICY_MAX_HISTORY="30" \
    CANTALOUPE_LOG_ACCESS_SYSLOGAPPENDER_ENABLED="false" \
    CANTALOUPE_LOG_ACCESS_SYSLOGAPPENDER_FACILITY="LOCAL0" \
    CANTALOUPE_LOG_ACCESS_SYSLOGAPPENDER_HOST= \
    CANTALOUPE_LOG_ACCESS_SYSLOGAPPENDER_PORT="514" \
    CANTALOUPE_LOG_APPLICATION_CONSOLEAPPENDER_ENABLED="true" \
    CANTALOUPE_LOG_APPLICATION_CONSOLEAPPENDER_LOGSTASH_ENABLED="false" \
    CANTALOUPE_LOG_APPLICATION_FILEAPPENDER_ENABLED="false" \
    CANTALOUPE_LOG_APPLICATION_FILEAPPENDER_LOGSTASH_ENABLED="false" \
    CANTALOUPE_LOG_APPLICATION_FILEAPPENDER_PATHNAME="/opt/tomcat/logs/cantaloupe.application.log" \
    CANTALOUPE_LOG_APPLICATION_LEVEL="debug" \
    CANTALOUPE_LOG_APPLICATION_ROLLINGFILEAPPENDER_ENABLED="false" \
    CANTALOUPE_LOG_APPLICATION_ROLLINGFILEAPPENDER_LOGSTASH_ENABLED="false" \
    CANTALOUPE_LOG_APPLICATION_ROLLINGFILEAPPENDER_PATHNAME="/opt/tomcat/logs/cantaloupe.application.log" \
    CANTALOUPE_LOG_APPLICATION_ROLLINGFILEAPPENDER_POLICY="TimeBasedRollingPolicy" \
    CANTALOUPE_LOG_APPLICATION_ROLLINGFILEAPPENDER_TIMEBASEDROLLINGPOLICY_FILENAME_PATTERN="/opt/tomcat/logs/cantaloupe.application-%d{yyyy-MM-dd}.log" \
    CANTALOUPE_LOG_APPLICATION_ROLLINGFILEAPPENDER_TIMEBASEDROLLINGPOLICY_MAX_HISTORY="30" \
    CANTALOUPE_LOG_APPLICATION_SYSLOGAPPENDER_ENABLED="false" \
    CANTALOUPE_LOG_APPLICATION_SYSLOGAPPENDER_FACILITY="LOCAL0" \
    CANTALOUPE_LOG_APPLICATION_SYSLOGAPPENDER_HOST= \
    CANTALOUPE_LOG_APPLICATION_SYSLOGAPPENDER_PORT="514" \
    CANTALOUPE_LOG_ERROR_FILEAPPENDER_ENABLED="false" \
    CANTALOUPE_LOG_ERROR_FILEAPPENDER_LOGSTASH_ENABLED="false" \
    CANTALOUPE_LOG_ERROR_FILEAPPENDER_PATHNAME="/opt/tomcat/logs/cantaloupe.error.log" \
    CANTALOUPE_LOG_ERROR_ROLLINGFILEAPPENDER_ENABLED="false" \
    CANTALOUPE_LOG_ERROR_ROLLINGFILEAPPENDER_LOGSTASH_ENABLED="false" \
    CANTALOUPE_LOG_ERROR_ROLLINGFILEAPPENDER_PATHNAME="/opt/tomcat/logs/cantaloupe.error.log" \
    CANTALOUPE_LOG_ERROR_ROLLINGFILEAPPENDER_POLICY="TimeBasedRollingPolicy" \
    CANTALOUPE_LOG_ERROR_ROLLINGFILEAPPENDER_TIMEBASEDROLLINGPOLICY_FILENAME_PATTERN="/opt/tomcat/logs/cantaloupe.error-%d{yyyy-MM-dd}.log" \
    CANTALOUPE_LOG_ERROR_ROLLINGFILEAPPENDER_TIMEBASEDROLLINGPOLICY_MAX_HISTORY="30" \
    CANTALOUPE_MAX_PIXELS="400000000" \
    CANTALOUPE_METADATA_PRESERVE="false" \
    CANTALOUPE_METADATA_RESPECT_ORIENTATION="false" \
    CANTALOUPE_OPENJPEGPROCESSOR_PATH_TO_BINARIES= \
    CANTALOUPE_OVERLAYS_BASICSTRATEGY_IMAGE="/path/to/overlay.png" \
    CANTALOUPE_OVERLAYS_BASICSTRATEGY_INSET="10" \
    CANTALOUPE_OVERLAYS_BASICSTRATEGY_OUTPUT_HEIGHT_THRESHOLD="300" \
    CANTALOUPE_OVERLAYS_BASICSTRATEGY_OUTPUT_WIDTH_THRESHOLD="400" \
    CANTALOUPE_OVERLAYS_BASICSTRATEGY_POSITION="bottom right" \
    CANTALOUPE_OVERLAYS_BASICSTRATEGY_STRING="Copyright. All rights reserved." \
    CANTALOUPE_OVERLAYS_BASICSTRATEGY_STRING_BACKGROUND_COLOR="rgba(0, 0, 0, 100)" \
    CANTALOUPE_OVERLAYS_BASICSTRATEGY_STRING_COLOR="white" \
    CANTALOUPE_OVERLAYS_BASICSTRATEGY_STRING_FONT="Helvetica" \
    CANTALOUPE_OVERLAYS_BASICSTRATEGY_STRING_FONT_MIN_SIZE="18" \
    CANTALOUPE_OVERLAYS_BASICSTRATEGY_STRING_FONT_SIZE="24" \
    CANTALOUPE_OVERLAYS_BASICSTRATEGY_STRING_FONT_WEIGHT="1.0" \
    CANTALOUPE_OVERLAYS_BASICSTRATEGY_STRING_GLYPH_SPACING="0.02" \
    CANTALOUPE_OVERLAYS_BASICSTRATEGY_STRING_STROKE_COLOR="black" \
    CANTALOUPE_OVERLAYS_BASICSTRATEGY_STRING_STROKE_WIDTH="1" \
    CANTALOUPE_OVERLAYS_BASICSTRATEGY_TYPE="image" \
    CANTALOUPE_OVERLAYS_ENABLED="false" \
    CANTALOUPE_OVERLAYS_STRATEGY="BasicStrategy" \
    CANTALOUPE_PRINT_STACK_TRACE_ON_ERROR_PAGES="true" \
    CANTALOUPE_PROCESSOR_BACKGROUND_COLOR="black" \
    CANTALOUPE_PROCESSOR_DOWNSCALE_FILTER="bicubic" \
    CANTALOUPE_PROCESSOR_DPI="150" \
    CANTALOUPE_PROCESSOR_FALLBACK_RETRIEVAL_STRATEGY="DownloadStrategy" \
    CANTALOUPE_PROCESSOR_IMAGEIO_BMP_READER= \
    CANTALOUPE_PROCESSOR_IMAGEIO_GIF_READER= \
    CANTALOUPE_PROCESSOR_IMAGEIO_GIF_WRITER= \
    CANTALOUPE_PROCESSOR_IMAGEIO_JPG_READER= \
    CANTALOUPE_PROCESSOR_IMAGEIO_JPG_WRITER= \
    CANTALOUPE_PROCESSOR_IMAGEIO_PNG_READER= \
    CANTALOUPE_PROCESSOR_IMAGEIO_PNG_WRITER= \
    CANTALOUPE_PROCESSOR_IMAGEIO_TIF_READER= \
    CANTALOUPE_PROCESSOR_IMAGEIO_TIF_WRITER= \
    CANTALOUPE_PROCESSOR_IMAGEIO_XPM_READER= \
    CANTALOUPE_PROCESSOR_JPG_PROGRESSIVE="true" \
    CANTALOUPE_PROCESSOR_JPG_QUALITY="80" \
    CANTALOUPE_PROCESSOR_MANUALSELECTIONSTRATEGY_AVI="FfmpegProcessor" \
    CANTALOUPE_PROCESSOR_MANUALSELECTIONSTRATEGY_BMP="ImageMagickProcessor" \
    CANTALOUPE_PROCESSOR_MANUALSELECTIONSTRATEGY_DCM="ImageMagickProcessor" \
    CANTALOUPE_PROCESSOR_MANUALSELECTIONSTRATEGY_FALLBACK="Java2dProcessor" \
    CANTALOUPE_PROCESSOR_MANUALSELECTIONSTRATEGY_GIF="ImageMagickProcessor" \
    CANTALOUPE_PROCESSOR_MANUALSELECTIONSTRATEGY_JP2="OpenJpegProcessor" \
    CANTALOUPE_PROCESSOR_MANUALSELECTIONSTRATEGY_JPG="ImageMagickProcessor" \
    CANTALOUPE_PROCESSOR_MANUALSELECTIONSTRATEGY_MOV="FfmpegProcessor" \
    CANTALOUPE_PROCESSOR_MANUALSELECTIONSTRATEGY_MP4="FfmpegProcessor" \
    CANTALOUPE_PROCESSOR_MANUALSELECTIONSTRATEGY_MPG="FfmpegProcessor" \
    CANTALOUPE_PROCESSOR_MANUALSELECTIONSTRATEGY_PDF="ImageMagickProcessor" \
    CANTALOUPE_PROCESSOR_MANUALSELECTIONSTRATEGY_PNG="ImageMagickProcessor" \
    CANTALOUPE_PROCESSOR_MANUALSELECTIONSTRATEGY_TIF="ImageMagickProcessor" \
    CANTALOUPE_PROCESSOR_MANUALSELECTIONSTRATEGY_WEBM="FfmpegProcessor" \
    CANTALOUPE_PROCESSOR_MANUALSELECTIONSTRATEGY_WEBP="ImageMagickProcessor" \
    CANTALOUPE_PROCESSOR_NORMALIZE="false" \
    CANTALOUPE_PROCESSOR_SELECTION_STRATEGY="ManualSelectionStrategy" \
    CANTALOUPE_PROCESSOR_SHARPEN="0" \
    CANTALOUPE_PROCESSOR_STREAM_RETRIEVAL_STRATEGY="StreamStrategy" \
    CANTALOUPE_PROCESSOR_TIF_COMPRESSION="LZW" \
    CANTALOUPE_PROCESSOR_UPSCALE_FILTER="bicubic" \
    CANTALOUPE_REDACTION_ENABLED="false" \
    CANTALOUPE_REDISCACHE_DATABASE="0" \
    CANTALOUPE_REDISCACHE_HOST="localhost" \
    CANTALOUPE_REDISCACHE_PASSWORD= \
    CANTALOUPE_REDISCACHE_PORT="6379" \
    CANTALOUPE_REDISCACHE_SSL="false" \
    CANTALOUPE_S3CACHE_ACCESS_KEY_ID= \
    CANTALOUPE_S3CACHE_BUCKET_NAME= \
    CANTALOUPE_S3CACHE_BUCKET_REGION= \
    CANTALOUPE_S3CACHE_ENDPOINT= \
    CANTALOUPE_S3CACHE_MAX_CONNECTIONS= \
    CANTALOUPE_S3CACHE_OBJECT_KEY_PREFIX= \
    CANTALOUPE_S3CACHE_SECRET_KEY= \
    CANTALOUPE_S3SOURCE_ACCESS_KEY_ID= \
    CANTALOUPE_S3SOURCE_BASICLOOKUPSTRATEGY_BUCKET_NAME= \
    CANTALOUPE_S3SOURCE_BASICLOOKUPSTRATEGY_PATH_PREFIX= \
    CANTALOUPE_S3SOURCE_BASICLOOKUPSTRATEGY_PATH_SUFFIX= \
    CANTALOUPE_S3SOURCE_CHUNKING_CACHE_ENABLED="true" \
    CANTALOUPE_S3SOURCE_CHUNKING_CACHE_MAX_SIZE="5M" \
    CANTALOUPE_S3SOURCE_CHUNKING_CHUNK_SIZE="512K" \
    CANTALOUPE_S3SOURCE_CHUNKING_ENABLED="true" \
    CANTALOUPE_S3SOURCE_ENDPOINT= \
    CANTALOUPE_S3SOURCE_LOOKUP_STRATEGY="BasicLookupStrategy" \
    CANTALOUPE_S3SOURCE_SECRET_KEY= \
    CANTALOUPE_SCALE_CONSTRAINTS_DELIMITER="-" \
    CANTALOUPE_SLASH_SUBSTITUTE= \
    CANTALOUPE_SOURCE_DELEGATE="false" \
    CANTALOUPE_SOURCE_STATIC="HttpSource" \
    CANTALOUPE_TEMP_PATHNAME=

COPY --link --from=download /opt/tomcat /opt/tomcat

COPY --link rootfs /

RUN chown tomcat:tomcat -R /opt/tomcat
