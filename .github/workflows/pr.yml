name: Build and Test Pull Request
on:
  pull_request:
    branches:
      - disabled
jobs:
  build:
    if: github.repository_owner != 'Islandora-Devops' # If the pull request is originating from inside the repo, we already build/test on push.
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      # We need to extend the IP range of the Docker Daemon so we can create
      # more than 31 bridge networks when performing tests.
      - name: Extend IP range.
        run: |
          cat << EOF > /tmp/daemon.json
          {
            "default-address-pools" : [
              {
                "base" : "172.17.0.0/12",
                "size" : 20
              },
              {
                "base" : "192.168.0.0/16",
                "size" : 24
              }
            ]
          }
          EOF
          sudo cp /tmp/daemon.json /etc/docker/daemon.json
          sudo systemctl restart docker
      - name: Expose GitHub Runtime
        uses: crazy-max/ghaction-github-runtime@v2
      - name: Checkout
        uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 11
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          arguments: build test grype # We do not push to the DockerHub as pull request can originate from forks only test a single architecture.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v3
        with:
          name: Grype Reports
          path: build/**/*-grype.*
